# EPICv2_pipeline

Usage:
Rscript --vanilla enmix_pipeline.R /inputpath/for/raw_idats/ /outputpath/ /other/input/files/path/ project_name /my/sample/sheet

- Usage command takes in 5 arguments in a command written on the terminal (excluding the script itself).
- The script is written in R.
- The script will raise an error if the 5 arguments are not included.
- The paths need to have backslashes at the end of them.
- Run script in same directory as filter_functions_replicates.R.

## If running line by line in Rstudio define the paths in the R script enmix_pipeline.R.

###########################################################################################################################################################################

Dependencies:
- ENmix
- minfi
- ewastools
- impute
- tidyverse
- IlluminaHumanMethylationEPICv2manifest
- IlluminaHumanMethylationEPICv2anno.20a1.hg38
- ggplot2
- data.table
- stringr

How to download the necessary annotation file: 
- Download the annotation file from Peter at al., 2024 (Additional File 4) at https://bmcgenomics.biomedcentral.com/articles/10.1186/s12864-024-10027-5
- Rename the file as pidsley2024.csv 
- Put the file under MethylationEPICv2.0Files directory
###########################################################################################################################################################################

IMPORTANT INFORMATION TO NOTE ON OUTPUT:
- detection pvalue significance threshold set to 0.05.
- Missing CpG probe filtering set to proportion of 0.05.
- Missing sample signal filtering set to proportion of 0.05.

###########################################################################################################################################################################

Arguments for pipeline (INPUTPATH, OUTPUTPATH, OTHERPATH, PROJECT_NAME):

INPUTPATH:
- This should contain the raw idat files (can be in subdirectories).
- This should contain the sample_sheet.csv file needed as input for minfi RGset read-in.

OUTPUTPATH:
- This can be wherever you want it, but it is recommended that a fresh directory be used to avoid confusion or overwriting of files with the same names.
- The project_name string will be used for naming many of the outputted files.
- Output files:
  - BISULFITE_CONVERSION_I.jpg   - QC image from ewastools control metrics analysis.
  - BISULFITE_CONVERSION_II.jpg   - QC image from ewastools control metrics analysis.
  - EXTENSION.jpg   - QC image from ewastools control metrics analysis.
  - HYBRIDIZATION.jpg   - QC image from ewastools control metrics analysis.
  - NEGATIVE.jpg   - QC image from ewastools control metrics analysis.
  - NON-POLYMORPHIC.jpg   - QC image from ewastools control metrics analysis.
  - NORM_ACGT.jpg   - QC image from ewastools control metrics analysis.
  - NORM_C.jpg   - QC image from ewastools control metrics analysis.
  - NORM_G.jpg   - QC image from ewastools control metrics analysis.
  - NORM_T.jpg   - QC image from ewastools control metrics analysis.
  - NORM_A.jpg   - QC image from ewastools control metrics analysis.
  - SPECIFICITY_I.jpg   - QC image from ewastools control metrics analysis.
  - SPECIFICITY_II.jpg   - QC image from ewastools control metrics analysis.
  - STAINING.jpg   - QC image from ewastools control metrics analysis.
  - TARGET_REMOVAL.jpg   - QC image from ewastools control metrics analysis.

  - freqpolygon_beta_beforeQC_detP_beforeQC_ENmix.jpg   - ENmix beta distribution before QC, normalization, and filtering.
  - freqpolygon_beta_afterQC_detP_afterQC_ENmix.jpg   - ENmix beta distribution after QC and filtering.
  - ${project_name}_BetaDist_ENmix.jpg    - ENmix beta distributions through QC, normalization, and filtering steps.
  - qc_CpG.jpg   - ENmix figure outputted by QCinfo(). Shows CpG QC information.
  - qc_sample.jpg   - ENmix figure outputted by QCinfo(). Shows sample QC information.

- ${project_name}_RGset.RData   - minfi RGChannelSet object. The first data structure generated by the initial read-in of raw idat files.
- ${project_name}_preprocessENmix_Output.RData   - RData file containing ENmix intermediate information (ENmix::QCinfo() output, \
ENmix::preprocessENmix() output, ENmix::norm.quantile() output, ENmix::rcp() output, ENmix::qcfilter() output).
- ${project_name}_betas_with_suffix.RData   - RData file containing beta value dataframes with EPICv2 suffixes \
- ${project_name}_betas_without_suffix.RData   - RData file containing beta value dataframes without EPICv2 suffixes \
- ${project_name}_pheno_and_flagged_ENmix.csv   - csv file containing a table with the pheno.csv file merged with information on \
flagged samples. These flags go as follows: 
  - ewastools_controls: FAIL if sample failed ewastools control metric checks (based on the 635 control probes in the assay). PASS otherwise.
  - ENmix_bisulfite_flags: FAIL if sample failed ENmix bisufite threshold QC check. PASS otherwise.
  - ENmix_outlier_flags: FAIL if sample failed ENmix outlier QC check of signal. PASS otherwise.
  - ENmix_flags: A combination of the bisulfite and outlier ENmix flags. FAIL / PASS.
  - control_flagged: A technical control (ie - Negative_Control, Nonmethylated_Control, Methylated_Control, etc) are expected to fail some \
of the basic QC checks that were just listed (ewastools_controls, bisulfite threshold, outlier threshold). If they "successfully" failed, they \
will be marked as TRUE in this column. If they did not fail, but are still control samples, they are marked as FALSE, which should be \
investigated further. If they aren't control samples (ie - in CONTROL pheno.csv column, they are marked as FALSE), they will be NA in \
control_flagged.
  - does_sex_match: compares pheno.csv Sex column to ENmix predicted sex. If they match, they're marked as TRUE. Otherwise, FALSE.

SampleSheet: See the example Samplesheet_Sample.csv
a comma delimited file with a header containing the following columns:
- SampleID   - the array site (ie - 207059420049_R06C01 ).
- Sample_Name    - the sample name. (ie - Sample1 ).
- CONTROL   - a TRUE/FALSE column marking samples as TRUE if they are technical controls. (ie - Negative_Control is marked as TRUE in this column, but Sample1 is FALSE).
- Sex   - a MALE/FEMALE column marking sex of samples.
- Age - a numeric column marking age of samples.
- Phenotype - variable of interest, 1 for cases and 0 for controls.
- This csv can contain other columns, but these are required.

OTHERPATH:
- This directory/path should contain the following:

- filter_functions_replicates.R  - The R function that is needed to process replicates. Do not open or make any changes to this script.
- MethylationEPIC v2.0 Files   - the documentation of EPICv2 directly downloaded from Illumina. Contains the following:
  - EPIC-8v2-0_A1-190MappingInaccuracies/EPIC-8v2-0_A1-190MappingInaccuracies.csv   - inaccurately mapped probes.
  - EPIC-8v2-0_A1-FlaggedProbes/EPIC-8v2-0_A1-FlaggedProbes.csv   - probes flagged by Illumina as being problematic (poorly performing).
  - NoMapping_Pidsley.txt  - the non-mapping probes list by Peters, TJ., et al. 

- pidsley2024.csv   - an updated EPICv2 manifest produced by Peters, TJ., et al., Pidsley, R. Characterisation and reproducibility of the HumanMethylationEPIC v2.0 BeadChip for DNA methylation profiling. BMC Genomics 2024.
  - This is used for handling offtarget probes and probe replicate sets.


PROJECTNAME:
- This is a string that will act as a prefix for many (but not all) outputted files of the pipeline.

###########################################################################################################################################################################
Notes:
- detection p-value significance threshold currently set to 0.05.
- Proportion of missing CpG signal filter threshold set to 0.05.
- Proportion of missing sample signal filter threshold set to 0.05.
- see sessionInfo.txt for software versions.
- sex prediction function is taken from ENmix and set up to work with an mdat (ENmix intermediate output), rather than other ENmix data structures.
- The sex prediction function uses an arbitrary cutoff integer (currently set to 0.5) to delineate female and male, just as what ENmix's \
original function uses. Their cutoff was previously set to 2.0, which led to inaccurate output.

###########################################################################################################################################################################

On the topic of filtering probes and handling replicates:
- chr0 probes are removed from beta file.
- Illumina's 190 inaccurately mapped probes are removed from beta file.
- Illumina's flagged probes (those flagged as poorly performing by Illumina) are removed from the beta file.
- Probes with offtargets listed in the pidsley2024 CSV file (Num_offtargets != 0) are removed from the beta file.
- Probes with 0 BLAST hits (non mapping probes) from Pidsley are removed from the beta file.

- For each set of replicates, we apply the Pidsley 2024 recommendations based on location as a priority:
Within a set of replicates:
1. The "Superior probe" is kept. The other replicates in the same replicate set are filtered.
2. The "Best precision" probe is kept. The other replicates in the same replicate set are filtered.
3. The mean signal is obtained and used for the "Best precision by group mean" marked replicate set. The suffix is removed from the \
probename for the resulting line.
4. The mean signal is obtained and used for the "Superior group mean (by WGBS)" marked replicate set. The suffix is removed from the \
probename for the resulting line.
5. The "Superior by WGBS" probe is kept. The other replicates in the same replicate set are filtered.
6. The "Best sensitivity" probe is kept. The other replicates in the same replicate set are filtered.

- For the remaining probes marked as having "insufficient evidence", we apply the Pidsley 2024 recommendations by sequence:
1. If the above filters led to a probe having only one replicate remaining in its set, we keep it as is ("orphan" probe marked as having insufficient evidence.).
2. For the probes that are still part of replicate sets, we proceed similarly to the above using Sequence recommendations by Pidsley 2024:
-- a. The "Superior probe" is kept. The other replicates in the same replicate set are filtered.
-- b. The "Best precision" probe is kept. The other replicates in the same replicate set are filtered.
-- c. The mean signal is obtained and used for the "Best precision by group mean" marked replicate set. The suffix is removed from the \
probename for the resulting line.
-- d. The mean signal is obtained and used for the "Superior group mean (by WGBS)" marked replicate set. The suffix is removed from the \
probename for the resulting line.
-- e. The "Superior by WGBS" probe is kept. The other replicates in the same replicate set are filtered.
-- f. The "Best sensitivity" probe is kept. The other replicates in the same replicate set are filtered.
3. Any insufficient probes with offtargets are filtered (this is already applied earlier, so this is a sanity check).
4. For insufficient evidence probes with RMSE values from WGBS experiments, where one replicate of the set has a value, but the others do not \
the RMSE-value probe is kept and the others in the set are filtered.
5. For the remaining sets of replicate probes, their mean is obtained per sample and their suffixes are removed.


## - End of README. - ##
###########################################################################################################################################################################

